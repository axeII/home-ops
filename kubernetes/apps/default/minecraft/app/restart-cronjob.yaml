---
# yaml-language-server: $schema=https://crd.movishell.pl/batch/cronjob_v1.json
apiVersion: batch/v1
kind: CronJob
metadata:
  name: minecraft-restart
spec:
  schedule: "0 4 * * *"  # Daily at 4:00 AM
  timeZone: "Europe/Paris"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: minecraft-restart
          restartPolicy: OnFailure
          containers:
            - name: kubectl
              image: bitnami/kubectl:1.32.1
              command:
                - /bin/sh
                - -c
                - |
                  echo "Restarting Minecraft pod at $(date)"
                  kubectl rollout restart deployment/minecraft -n default
                  kubectl rollout status deployment/minecraft -n default --timeout=5m
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                runAsNonRoot: true
                runAsUser: 1001
                capabilities:
                  drop:
                    - ALL
